var requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)};window.requestAnimationFrame=requestAnimationFrame;let planeCnv=document.getElementById("plane"),backgroundCnv=document.getElementById("background"),obstacleCnv=document.getElementById("obstacle"),planeCtx=planeCnv.getContext("2d"),obstacleCtx=obstacleCnv.getContext("2d"),backgroundCtx=backgroundCnv.getContext("2d"),btnStart=document.getElementById("btn-start"),modal=document.getElementById("modal"),gameParams={play:!1,pause:!0,time:{minutes:0,seconds:0,ms:0,logo:loadImage("assets/images/clock.png",24,24),timer:function(){gameParams.pause||(this.seconds=Math.floor(this.ms%1e3),60==this.seconds&&(this.seconds=0,this.ms=0,this.minutes++),setTimeout(()=>{this.ms++,this.timer()},1e3))}},plane:{img:"assets/images/airplane.png",imgFuel:"assets/images/fuel.png",width:110,height:40,fuel:10,fuelConsumption:1,fallingSpeed:1},clouds:{cloudsImg:[{image:"assets/images/clouds/cloud-1.png",width:226,height:111},{image:"assets/images/clouds/cloud-2.png",width:294,height:99},{image:"assets/images/clouds/cloud-3.png",width:467,height:172},{image:"assets/images/clouds/cloud-4.png",width:201,height:83},{image:"assets/images/clouds/cloud-5.png",width:375,height:159},{image:"assets/images/clouds/cloud-6.png",width:273,height:128},{image:"assets/images/clouds/cloud-7.png",width:340,height:159}]},obstacle:{stars:{img:loadImage("assets/images/star.png",28,24),count:0,chance:15},parachute:{img:loadImage("assets/images/parachute.png",41,40),chance:25},bird:{img:loadImage("assets/images/sprite.png",4096,512,8),chance:60}},gameWindow:{width:1024,height:768},volume:{music:.2,effects:.2}},canvas=document.querySelectorAll(".canvas");for(let e=0;e<canvas.length;e++)canvas[e].setAttribute("width",gameParams.gameWindow.width),canvas[e].setAttribute("height",gameParams.gameWindow.height);backgroundCtx.font="18px Filmotype Quiet",backgroundCtx.fillStyle="red";let plane={img:loadImage(gameParams.plane.img,gameParams.plane.width,gameParams.plane.height),fuelLogo:loadImage(gameParams.plane.imgFuel,17,24),fuel:gameParams.plane.fuel,x:457,y:324,state:!1,actions:function(){this.drop()},drop:function(){this.y+=gameParams.plane.fallingSpeed},up:function(){this.y-=3},down:function(){this.y+=3},fuelConsumption:function(){!gameParams.pause&&gameParams.play&&setTimeout(()=>{this.fuel-=gameParams.plane.fuelConsumption,this.fuelConsumption()},1e3)}},Cloud=function(e,a,t,s,o,i){this.image=e,this.width=a,this.height=t,this.x=s,this.y=o,this.speed=i};Cloud.prototype={move:function(){this.x-=this.speed}};let parachuteAudio=loadAudio(["assets/audio/parachute.mp3"],gameParams.volume.music),Parachute=function(e,a,t,s){this.x=e,this.y=a,this.width=t,this.height=s};Parachute.prototype={img:gameParams.obstacle.parachute.img,move:function(){this.x-=1,this.y+=1},audio:loadAudio(["assets/audio/parachute.mp3"],gameParams.volume.music),checkplane:function(){let e=[{x:this.x,y:this.y},{x:this.x+40,y:this.y},{x:this.x+27,y:this.y+40},{x:this.x+13,y:this.y+40}],a=[{x:plane.x,y:plane.y},{x:plane.x+110,y:plane.y+13},{x:plane.x+91,y:plane.y+31},{x:plane.x+14,y:plane.y+35}];for(var t=0;t<e.length;t++)for(var s=e[t],o=e[(t+1)%e.length],i=0;i<a.length;i++){if(segmentIntersect(s,o,a[i],a[(i+1)%a.length]))return parachuteAudio.play(),plane.fuel=gameParams.plane.fuel,this.width=0,this.height=0,this.x=0,this.y=0,!0}return!1}};let Star=function(e,a,t,s){this.x=e,this.y=a,this.width=t,this.height=s};Star.prototype={img:gameParams.obstacle.stars.img,move:function(){this.x-=1,this.y+=1},audio:loadAudio(["assets/audio/star.mp3"],gameParams.volume.music),checkplane:function(){let e=[{x:this.x,y:this.y},{x:this.x+this.width,y:this.y},{x:this.x+this.width,y:this.y+24},{x:this.x,y:this.y+24}],a=[{x:plane.x,y:plane.y},{x:plane.x+110,y:plane.y+13},{x:plane.x+91,y:plane.y+31},{x:plane.x+14,y:plane.y+35}];for(var t=0;t<e.length;t++)for(var s=e[t],o=e[(t+1)%e.length],i=0;i<a.length;i++){if(segmentIntersect(s,o,a[i],a[(i+1)%a.length]))return this.audio.play(),gameParams.obstacle.stars.count++,this.width=0,this.height=0,this.x=0,this.y=0,!0}return!1}};let Bird=function(e,a,t,s,o){this.x=e,this.y=a,this.width=t,this.height=s,this.num=1,this.speed=o};function segmentIntersect(e,a,t,s){var o=a.y-e.y,i=e.x-a.x,m=o*e.x+i*e.y,n=s.y-t.y,l=t.x-s.x,u=n*t.x+l*t.y,g=o*l-n*i;if(0==g)return null;var d=(l*m-i*u)/g,h=(o*u-n*m)/g,r=(d-e.x)/(a.x-e.x),c=(h-e.y)/(a.y-e.y),p=(d-t.x)/(s.x-t.x),y=(h-t.y)/(s.y-t.y);return(r>=0&&r<=1||c>=0&&c<=1)&&(p>=0&&p<=1||y>=0&&y<=1)?{x:d,y:h}:null}function getCloudsImg(){let e=[];for(cloudImg of gameParams.clouds.cloudsImg){let a=loadImage(cloudImg.image,cloudImg.width,cloudImg.height);e.push(a)}return e}Bird.prototype={img:gameParams.obstacle.bird.img,move:function(){this.x-=this.speed},audio:loadAudio(["assets/audio/bird.mp3"],gameParams.volume.music),checkplane:function(){let e=[{x:this.x+15,y:this.y+25},{x:this.x+60,y:this.y+25},{x:this.x+51,y:this.y+43},{x:this.x+13,y:this.y+40}],a=[{x:plane.x,y:plane.y},{x:plane.x+110,y:plane.y+13},{x:plane.x+91,y:plane.y+31},{x:plane.x+14,y:plane.y+35}];for(var t=0;t<e.length;t++)for(var s=e[t],o=e[(t+1)%e.length],i=0;i<a.length;i++){if(segmentIntersect(s,o,a[i],a[(i+1)%a.length]))return this.width=0,this.height=0,this.x=0,this.y=0,this.audio.play(),gameOver(),!0}return!1}};let cloudsImg=getCloudsImg(),clouds=[];function getClouds(){if(!gameParams.pause&&gameParams.play){let e=Math.floor(Math.random()*cloudsImg.length),a=Math.floor(660*Math.random())-15,t=Math.floor(5e3*Math.random()),s=new Cloud(cloudsImg[e].dom,cloudsImg[e].width,cloudsImg[e].height,1024,a,2);clouds.push(s),setTimeout(()=>{getClouds()},t)}}let obstacle=[];function getRandomObstacle(){if(!gameParams.pause&&gameParams.play){let e=Math.floor(100*Math.random()),a=Math.floor(Math.random()*(gameParams.gameWindow.width/2))+gameParams.gameWindow.width/1.75,t=Math.floor(660*Math.random())-15,s=Math.floor(1500*Math.random()),o=Math.floor(4*Math.random())+1,i=gameParams.obstacle.bird.chance,m=gameParams.obstacle.stars.chance;e<=i?obstacle.push(new Bird(1024,t,gameParams.obstacle.bird.img.width,gameParams.obstacle.bird.img.height,o)):e>i&&e<m+i?obstacle.push(new Parachute(a,-30,gameParams.obstacle.parachute.img.width,gameParams.obstacle.parachute.img.height)):obstacle.push(new Star(a,-30,gameParams.obstacle.stars.img.width,gameParams.obstacle.stars.img.height)),setTimeout(()=>{getRandomObstacle()},s)}}function drawClouds(){for(let e=0;e<clouds.length;e++)clouds[e].move(),backgroundCtx.drawImage(clouds[e].image,clouds[e].x,clouds[e].y,clouds[e].width,clouds[e].height),clouds[e].x<=-1e3&&clouds.splice(e,1)}function drawObstacle(){for(let e=0;e<obstacle.length;e++)obstacle[e].move(),obstacle[e].checkplane(),1==obstacle[e].img.count?obstacleCtx.drawImage(obstacle[e].img.dom,obstacle[e].x,obstacle[e].y,obstacle[e].width,obstacle[e].height):(obstacle[e].num>=obstacle[e].img.count&&(obstacle[e].num=0),obstacleCtx.drawImage(obstacle[e].img.dom,obstacle[e].width/8*obstacle[e].num,0,obstacle[e].width/8,obstacle[e].height,obstacle[e].x,obstacle[e].y,64,64),obstacle[e].num++),obstacle[e].x<=-500&&obstacle.splice(e,1)}function drawTime(){let e=gameParams.time.seconds;gameParams.time.minutes&&(e=gameParams.time.minutes+" : "+gameParams.time.seconds),backgroundCtx.drawImage(gameParams.time.logo.dom,105,5,gameParams.time.logo.width,gameParams.time.logo.height),backgroundCtx.fillText(e,140,23)}function drawFuel(){let e=plane.fuel/gameParams.plane.fuel*100;backgroundCtx.drawImage(plane.fuelLogo.dom,13,119,plane.fuelLogo.width,plane.fuelLogo.height),backgroundCtx.rect(40,143,20,-e),backgroundCtx.fillRect(40,143,20,-e),plane.fuel<=0&&gameOver()}function drawStarsCount(){backgroundCtx.drawImage(gameParams.obstacle.stars.img.dom,10,5,gameParams.obstacle.stars.img.width-3,gameParams.obstacle.stars.img.height-2),backgroundCtx.fillText(gameParams.obstacle.stars.count,45,23)}function drawPlane(){(plane.y>gameParams.gameWindow.height-plane.img.height||plane.y<0)&&gameOver(),(plane.x>gameParams.gameWindow.width-plane.img.width||plane.x<0)&&gameOver(),plane.actions(),planeCtx.drawImage(plane.img.dom,plane.x,plane.y,plane.img.width,plane.img.height)}function startGame(){gameParams.play=!gameParams.play,gameParams.obstacle.stars.count=0,gameParams.time.ms=0,gameParams.time.minutes=0,plane.fuel=gameParams.plane.fuel,plane.x=457,plane.y=324,clouds=[],obstacle=[],gamePause(),setTimeout(()=>{plane.fuelConsumption()},5e3)}function gamePause(){gameParams.pause=!gameParams.pause,gameParams.pause?theme.pause():theme.play(),gameParams.time.timer(),gameLoop(),getClouds(),getRandomObstacle()}function gameOver(){endOfFuel.play(),plane.state=!0,gameParams.pause=!gameParams.pause,gameParams.play=!gameParams.play,theme.pause(),setTimeout(()=>{modal.style.display="flex",plane.state=!1},50)}function loadImage(e,a,t,s){let o=document.createElement("img"),i={dom:o,width:a,height:t,count:s||1,loaded:!1};return o.onload=function(){i.loaded=!0},o.src=e,i}function gameLoop(){gameParams.pause||(planeCtx.clearRect(0,0,1024,768),backgroundCtx.clearRect(0,0,1024,768),obstacleCtx.clearRect(0,0,1024,768),drawPlane(),drawClouds(),drawObstacle(),drawTime(),drawFuel(),drawStarsCount(),requestAnimationFrame(gameLoop))}function loadAudio(e,a){for(var t=document.createElement("audio"),s=0,o=e.length;s<o;s+=1){var i=document.createElement("source");i.src=e[s],t.appendChild(i)}t.volume=a||1;var m={dom:!1,state:"stop",play:function(){this.dom.currentTime=0,this.dom.play(),this.state="play"},pause:function(){this.dom.pause(),this.state="pause"},stop:function(){this.dom.pause(),this.dom.currentTime=0,this.state="stop"},setVolume:function(e){this.dom.volume=e}};return m.dom=t,m}document.onkeydown=function(e){27==e.keyCode&&gameParams.play&&gamePause(),87!=e.keyCode&&38!=e.keyCode||plane.state||(plane.state=!0,plane.actions=plane.up,setTimeout(()=>{plane.actions=plane.drop,plane.state=!1},300)),83!=e.keyCode&&40!=e.keyCode||plane.state||(plane.state=!0,plane.actions=plane.down,setTimeout(()=>{plane.actions=plane.drop,plane.state=!1},300)),65!=e.keyCode&&37!=e.keyCode||(plane.x-=8),68!=e.keyCode&&39!=e.keyCode||(plane.x+=8),80==e.keyCode&&theme.stop()};var theme=loadAudio(["assets/audio/theme.mp3"],gameParams.volume.music),endOfFuel=loadAudio(["assets/audio/endOfFuel.mp3"],gameParams.volume.music);btnStart.onclick=function(){modal.style.display="none",startGame()};